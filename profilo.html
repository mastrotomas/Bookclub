<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body id="corpo">

    <div id="blackLayer"></div>
    
    <div id="sideBar" class="sideBar">
    <header class="sideBarHeader">BookClub
    
    </header>
    <hr class="line">
    <div id="SideBarContent" class="contenutoSideBar">
    
    </div>
    
    </div>
    
    <div id="LoginScreen" class="Login">
    <h1 id="logintitle"> Ti diamo il benvenuto </h1>
    <form id="dataForm">
        <fieldset class="loginfield">
        <legend>Username</legend>
        <input type="text" id="username" class="search-input" placeholder="Nome">
        </fieldset>
    
        <fieldset class="loginfield">
        <legend>Password</legend>
        <input type="password" class="search-input" id="password" placeholder="Password">
        </fieldset>
    
        <button id="submit" class="buttonStyle">Continua</button>
    </form>
    <p id="register">Non hai un account?<a id="asumbit">Registrati</a></p>
    <p id="response" style="opacity:0; transition: opacity 0.5s;"></p>
    </div>
    
    <div id="registerScreen" class="Registrazione">
        <h1 id="registertitle"> Ti diamo il benvenuto </h1>
        <form id="registerForm">
            <fieldset class="loginfield">
                <legend>Username</legend>
                <input type="text" id="registerusername" class="search-input" placeholder="Nome" required>
            </fieldset>
    
            <fieldset class="loginfield">
                <legend>EMail</legend>
                <input type="email" class="search-input" id="registeremail" placeholder="Email" required>
            </fieldset>
        
            <fieldset class="loginfield">
                <legend>Password</legend>
                <input type="password" class="search-input" id="registerpassword" placeholder="Password" required>
            </fieldset>
        
            <button id="registerSubmit" class="buttonStyle">Continua</button>
        </form>
        <p id="response"></p>
        </div>
    
    <header>
    <div id="menuBar">
        <div>
            <button id="sideBarExit" class="material-icons" style="background: transparent; border: none; cursor: pointer;" onclick="openNav()" >menu</button>
            <button class="material-icons" style="background: transparent; border: none; cursor: pointer;" onclick="goHome()" >home</button>
        </div>
        <div class="searching">
                <div class="search">
                <img class="magnifyglass" src="assets/magnifyglass.png" alt="Image #6">
                <input type="search" id ="searchINput" class="search-input" placeholder="Search">
                </div>
    
        </div>
        <div id="loggedTool" style="display: none;">
            <div class="dropdown">
                <button id="buttonoLogin" class="buttonloginLogged"></button>
                <div class="content">
                    <div id="AccountPreference" class="tastoAccount">Preferenze Account</div>
                    <div id="MyBook" class="tastoAccount">I miei libri</div>
                    <div id="MyComment" class="tastoAccount">I miei commenti</div>
                    <div id="addBook" class="tastoAccount">Aggiungi Libri</div>
                    <div style = "display:none;" id="manageRequest" class="tastoAccount">Approvazione libri</div>
                    <div id="exitButton" class="tastoAccount">Logout</div>
                </div>
            </div>
        </div>
    <button id="buttonLogin" class="material-icons" style="background: transparent; border: none; cursor: pointer;">login</button>
       
    </div>
    </header>
    <main>
        <div style="display:flex; flex-direction:column; align-items:center;">
        <div>
            <h1 style="text-align: center;">Modifica Profilo</h1>
        </div>
        <div>
    
            <!-- Box per la modifica dell'username -->
             <form id="ModificaUtente">
            <div>
                <label for="modificaUsername">Username</label>
                <div class="editable-field">
                    <input type="text" id="modificaUsername" class="search-inputa" value="" disabled>
                    <button type="button" class="edit-button" onclick="enableEdit('modificaUsername')">
                        <i class="fas fa-pencil-alt" style="width: 20px; height: 20px;"></i>
                    </button>                    
                </div>
            </div>
            
            <div>
                <label for="modificaEmail">Email</label>
                <div class="editable-field">
                    <input type="email" id="modificaEmail" class="search-inputa" value="" disabled>
                    <button type="button" class="edit-button" onclick="enableEdit('modificaEmail')">
                        <i class="fas fa-pencil-alt" style="width: 20px; height: 20px;"></i>
                    </button>                    
                </div>
            </div>
            
            <div>
                <label for="modificaPassword">Password</label>
                <div class="editable-field">
                    <input type="password" id="modificaPassword" class="search-inputa" value="" disabled>
                    <button type="button" class="edit-button" onclick="enableEdit('modificaPassword')">
                        <i class="fas fa-pencil-alt" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>
            </div>
            
            <h3>Generi preferiti</h3>
            <div style="display: flex; flex-direction: column; flex-wrap: wrap; height: 200px;"id="GeneriPreferiti"class="checkboxing">

            </div>
            <!-- Bottone per salvare le modifiche -->
            <div style="padding-top: 20px;">
                <label for="Password COnfirmation">Inserisci la password attuale per salvare le modifiche</label>
                <div class="editable-field">
                    <input type="password" id="confermaPassword" class="search-inputa" value="" required>
                    <button type="button" class="edit-button">
                    </button>                    
                </div>
            </div>
            <div style="text-align: center;padding-top: 5px;">
            </br>
                <button type="submit" id="saveChanges" class="buttonStyle">Salva Modifiche</button>
            </form>
            <p id="esito"></p>
            </div>
        </div>
        </div>
    </main>
    
    

        <script src="index.js"></script>
        <script>

            window.addEventListener('DOMContentLoaded', () => {
                getUserData();
                if(localStorage.getItem("esitotemporaneo")){
                    document.getElementById('esito').textContent = "Cambiamenti effettuati";
                    document.getElementById('esito').style.opacity = 1;
                    setTimeout(() => {
                        document.getElementById('esito').style.opacity = 0;
                    }, 5000);
                    localStorage.removeItem("esitotemporaneo");
                }

            })
            
            document.getElementById("ModificaUtente").addEventListener('submit', async (e) => {
                e.preventDefault(); 
                const formData = new FormData();

                // Aggiungi i dati del form
                formData.append("usernameOriginale", localStorage.getItem("nomeUtenteLoggato"));
                formData.append("username", document.getElementById("modificaUsername").value);
                formData.append("email", document.getElementById("modificaEmail").value);

                window.GeneridiLibro.forEach(genere => {
                    formData.append(genere, document.getElementById(genere).checked);
                });

                if(document.getElementById("modificaPassword")){
                    formData.append("password", document.getElementById("modificaPassword").value);
                }
                formData.append("passwordconf",document.getElementById("confermaPassword").value);
                try {
                    // Invia i dati al backend Flask
                    const response = await fetch('http://127.0.0.1:5000/updateUser', {
                        method: 'POST',
                        body: formData
                    });

                    // Ricevi e mostra la risposta dal server
                    const result = await response.json();
                    if(result.esito == 1){
                        localStorage.setItem("nomeUtenteLoggato",result.username);
                        localStorage.setItem("initialnameletter",result.firstletter);
                        const inputFields = document.querySelectorAll('.search-inputa');
                
                        // Salva le modifiche 
                        inputFields.forEach(function(input) {
                            input.disabled = true;  // Disabilita i campi dopo la modifica
                        });
                        localStorage.setItem("esitotemporaneo", 1);
                        location.reload();
                    }else{
                        document.getElementById('esito').textContent = "Password di conferma non corretta";
                        document.getElementById('esito').style.opacity = 1;
                        setTimeout(() => {
                            document.getElementById('esito').style.opacity = 0;
                        }, 5000);
                    }
                    
                } catch (error) {
                    console.error('Errore durante l\'invio dei dati:', error);
                    document.getElementById('response').textContent = "Errore durante la registrazione";
                }

            });


            async function getUserData(){
                const registerData = {
                    valorecercato: localStorage.getItem("nomeUtenteLoggato"),
                };

                try{
                    const response = await fetch('http://127.0.0.1:5000/getUserData', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(registerData)
                    });

                    const results = await response.json(); // Supponiamo che il backend restituisca un array di libri
                    const nickname = document.getElementById("modificaUsername");
                    nickname.value = localStorage.getItem("nomeUtenteLoggato");
                    const email = document.getElementById("modificaEmail");
                    email.value = results.email;
                    const password = document.getElementById("modificaPassword");
                    password.value = results.password;
                    const preferenze = results.preferenze;
                    const GeneriPreferitiLabel = document.getElementById("GeneriPreferiti");
                    window.GeneridiLibro.forEach(categoria =>{
                        const label = document.createElement("label");
                        const checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.id = categoria;

                        label.appendChild(checkbox);

                        const Testo = document.createTextNode(categoria);
                        label.appendChild(Testo);

                        GeneriPreferitiLabel.appendChild(label);

                        preferenze.forEach(pref =>{
                            if(checkbox.id == pref){
                                checkbox.checked = true;
                            }
                        })

                        
                })

                } catch (error) {
                    console.error("Errore durante l'invio dei dati:", error);
                }
            }

            // Funzione per abilitare la modifica del campo
            function enableEdit(fieldId) {
                const inputField = document.getElementById(fieldId);
                const saveButton = document.getElementById("saveChanges");

                // Abilita il campo di input
                inputField.disabled = false;
                document.getElementById(fieldId).value = "";
            }

        </script>
</body>

</html>